name: OCI Terraform Shared (Simple)

on:
    workflow_call:
        inputs:
            mode:
                required: true
                type: string
            region:
                required: false
                type: string
                default: "fra"
            config_subpath:
                required: false
                type: string
                default: "oci"
        secrets:
            GH_PAT:
                required: true

jobs:
    run:
        name: "OCI shared workflow (Simple)"
        runs-on: self-hosted
        permissions:
            contents: read
            pull-requests: write
            issues: write
            actions: read
            packages: read
            repository-projects: read
        env:
            TF_ACTION_WORKSPACE: "default"
            SCENARIO: oci
            CORE_MODULE_VERSION: v0.0.17
            MODE: ${{ inputs.mode }}
            CONFIG_SUBPATH: ${{ inputs.config_subpath }}
            REGION_INPUT: ${{ inputs.region }}
        steps:
            - name: "Checkout"
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Configure Git credentials for private repos
              run: |
                  git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

            - name: Clone OCI Orchestrator
              env:
                  GH_TOKEN: ${{ secrets.GH_PAT }}
              run: git clone https://${GH_TOKEN}@github.com/iblake/clickops-terraform-oci-modules-orchestrator.git ORCH

            - name: "Setup Terraform"
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.12.1
                  terraform_wrapper: true

            - name: "Setup Orchestrator Instance Principal Auth"
              run: |
                  cat > ${{ github.workspace }}/ORCH/providers.tf << 'EOF'
                  provider "oci" {
                    auth                = "InstancePrincipal"
                    region              = var.region
                    ignore_defined_tags = ["Oracle-Tags.CreatedBy", "Oracle-Tags.CreatedOn"]
                  }

                  provider "oci" {
                    auth                = "InstancePrincipal"
                    alias               = "home"
                    region              = var.region
                    ignore_defined_tags = ["Oracle-Tags.CreatedBy", "Oracle-Tags.CreatedOn"]
                  }

                  provider "oci" {
                    auth                = "InstancePrincipal"
                    alias               = "secondary_region"
                    region              = var.region
                    ignore_defined_tags = ["Oracle-Tags.CreatedBy", "Oracle-Tags.CreatedOn"]
                  }

                  terraform {
                    required_version = ">= 1.3.0"
                    required_providers {
                      oci = {
                        source                = "oracle/oci"
                        configuration_aliases = [oci.home]
                      }
                    }
                    backend "oci" {
                      bucket    = "__BUCKET__"
                      namespace = "__NAMESPACE__"
                      auth      = "InstancePrincipal"
                      region    = "__REGION__"
                    }
                  }
                  EOF
                  source /opt/actions-runner/.github-runner-env
                  sed -i "s|__BUCKET__|$OCI_TF_STATE_BUCKET|g" ${{ github.workspace }}/ORCH/providers.tf
                  sed -i "s|__NAMESPACE__|$OCI_TF_STATE_NAMESPACE|g" ${{ github.workspace }}/ORCH/providers.tf
                  sed -i "s|__REGION__|$OCI_REGION|g" ${{ github.workspace }}/ORCH/providers.tf
                  cd ${{ github.workspace }}/ORCH
                  terraform fmt providers.tf

            - name: "Terraform Init"
              run: |
                  cd ${{ github.workspace }}/ORCH
                  terraform init

            - name: Replace sensitive values in config files
              run: |
                  source /opt/actions-runner/.github-runner-env
                  find ${{ github.workspace }}/oci -name '*.json' -exec sed -i "s|__ATP_ADMIN_PASSWORD__|$ATP_ADMIN_PASSWORD|g" {} \;

            - name: Terraform Format
              id: format
              if: ${{ inputs.mode == 'pr' && github.event_name == 'pull_request' }}
              run: |
                  cd ${{ github.workspace }}/ORCH
                  terraform fmt
                  terraform fmt -check

            - name: "Terraform Validate"
              id: validate
              if: ${{ inputs.mode == 'pr' && github.event_name == 'pull_request' }}
              run: |
                  cd ${{ github.workspace }}/ORCH
                  terraform validate -no-color

            - name: "Terraform Plan"
              id: plan
              run: |
                  set -euo pipefail
                  source /opt/actions-runner/.github-runner-env
                  cd ${{ github.workspace }}/ORCH
                  CONFIG_DIR=${{ github.workspace }}/${CONFIG_SUBPATH}
                  VARS=$(find "$CONFIG_DIR" -name '*.json')
                  echo "Planning with files:\n$VARS"

                  set +e
                  PLAN_OUTPUT=$(terraform plan -detailed-exitcode -no-color \
                    -var="region=${OCI_REGION}" \
                    -var="tenancy_ocid=dummy" \
                    -var="user_ocid=dummy" \
                    -var="fingerprint=dummy" \
                    -var="private_key_path=dummy" \
                    -var="private_key_password=dummy" \
                    $(for i in $VARS; do echo "-var-file $i"; done) -out=tfplan.binary 2>&1)
                  PLAN_EXIT_CODE=$?
                  set -e

                  if [ "$PLAN_EXIT_CODE" -eq 1 ]; then
                    echo "$PLAN_OUTPUT"
                    exit 1
                  fi

                  SANITIZED_PLAN=$(echo "$PLAN_OUTPUT" | \
                    sed -E "s|ocid1\.[a-z]+\.[a-z0-9]+\.[^.]+\.[a-z0-9]+|ocid1.***REDACTED***|g" | \
                    sed -E "s|\"tenancy_ocid\"[[:space:]]*=[[:space:]]*\"[^\"]+\"|\"tenancy_ocid\" = \"***\"|g" | \
                    sed -E "s|\"compartment_id\"[[:space:]]*=[[:space:]]*\"[^\"]+\"|\"compartment_id\" = \"***\"|g" | \
                    sed -E "s|admin_password[[:space:]]*=[[:space:]]*\"[^\"]+\"|admin_password = \"***\"|g" | \
                    sed -E "s|__ATP_ADMIN_PASSWORD__|***|g")

                  {
                    echo "plan_output<<'EOF'"
                    echo "$SANITIZED_PLAN"
                    echo "EOF"
                    echo "plan_exit_code=$PLAN_EXIT_CODE"
                  } >> "$GITHUB_OUTPUT"

            - name: Post PR comment
              if: ${{ inputs.mode == 'pr' && github.event_name == 'pull_request' }}
              uses: actions/github-script@v7
              env:
                  PLAN: ${{ steps.plan.outputs.plan_output }}
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const output = `#### Terraform Format ðŸ–Œ \`${{ steps.format.outcome }}\`
                      #### Terraform Validate ðŸ¤– \`${{ steps.validate.outcome }}\`
                      #### Terraform Plan ðŸ“– \`${{ steps.plan.outcome }}\`

                      <details><summary>Show Plan</summary>

                      \`\`\`terraform
                      ${process.env.PLAN}
                      \`\`\`

                      </details>

                      *Pushed by: @${{ github.actor }}*`;
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      });

            - name: Upload plan log
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: oci-terraform-plan
                  path: ${{ github.workspace }}/ORCH/tfplan.binary
                  if-no-files-found: ignore

            - name: Terraform Apply (on PR merge)
              id: apply
              if: ${{ inputs.mode == 'pr' && github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true }}
              run: |
                  source /opt/actions-runner/.github-runner-env
                  cd ${{ github.workspace }}/ORCH
                  CONFIG_DIR=${{ github.workspace }}/${CONFIG_SUBPATH}
                  VARS=$(find "$CONFIG_DIR" -name '*.json')
                  terraform apply -auto-approve \
                    -var="region=${OCI_REGION}" \
                    -var="tenancy_ocid=dummy" \
                    -var="user_ocid=dummy" \
                    -var="fingerprint=dummy" \
                    -var="private_key_path=dummy" \
                    -var="private_key_password=dummy" \
                    $(for i in $VARS; do echo "-var-file $i"; done)
