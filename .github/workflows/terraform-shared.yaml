name: Shared Terraform Workflow

on:
  workflow_call:
    inputs:
      mode:
        description: "pr or apply"
        required: true
        type: string
      cloud:
        description: "oci or azure"
        required: true
        type: string
      region:
        description: "Config region folder name (e.g., eu-frankfurt-1, westeurope). If omitted, REGION (or STATE_REGION) from the runner is used."
        required: false
        type: string
        default: ""
      orchestrator_repo:
        description: "Repository for Terraform modules"
        required: true
        type: string
      bucket_name:
        description: "Bucket name for Terraform state"
        required: true
        type: string
      runner_labels:
        description: "Runner labels as JSON array"
        required: false
        type: string
        default: '["self-hosted","oci"]'

jobs:
  terraform:
    name: "Terraform ${{ inputs.mode }}"
    runs-on: ${{ fromJSON(inputs.runner_labels) }}
    concurrency:
      group: ${{ inputs.cloud }}-terraform-${{ github.repository }}
      cancel-in-progress: false

    steps:
      # =====================================================================
      # Setup
      # =====================================================================
      - name: Checkout manifest repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout orchestrator
        uses: actions/checkout@v6
        with:
          repository: ${{ inputs.orchestrator_repo }}
          path: ORCH

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.1
          terraform_wrapper: false

      # =====================================================================
      # Resolve config
      # =====================================================================
      - name: Resolve config
        id: config
        shell: bash
        run: |
          CONFIG_REGION="${{ inputs.region }}"
          if [ -z "$CONFIG_REGION" ]; then
            # Attempt auto-detection from changed files
            # This logic assumes paths like: oci/<region>/...
            # We use git diff to find changed files in the PR or commit
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
            
            # Extract region from the first file that matches the cloud pattern
            DETECTED_REGION=$(echo "$CHANGED_FILES" | grep "^${{ inputs.cloud }}/" | cut -d/ -f2 | head -n 1)
            
            if [ -n "$DETECTED_REGION" ]; then
               CONFIG_REGION="$DETECTED_REGION"
               echo "ℹ️  Auto-detected region from changes: $CONFIG_REGION"
            fi
          fi

          if [ -z "$CONFIG_REGION" ]; then
            CONFIG_REGION="${REGION:-}"
          fi
          if [ -z "$CONFIG_REGION" ]; then
            CONFIG_REGION="${STATE_REGION:-}"
            if [ -n "$CONFIG_REGION" ]; then
              echo "ℹ️  Using STATE_REGION as config region. Set REGION if config differs."
            fi
          fi

          if [ -z "$CONFIG_REGION" ]; then
            echo "❌ Config region not set. Provide workflow input 'region', rely on auto-detection from file paths, or set REGION on the runner."
            exit 1
          fi

          CONFIG_SUBPATH="${{ inputs.cloud }}/$CONFIG_REGION"
          if [ ! -d "$CONFIG_SUBPATH" ]; then
            echo "❌ Config directory not found: $CONFIG_SUBPATH"
            echo "Available directories under ${{ inputs.cloud }}/:"
            ls -la "${{ inputs.cloud }}" || true
            exit 1
          fi

          STATE_KEY="${{ inputs.bucket_name }}/${{ github.repository }}/$CONFIG_SUBPATH/terraform.tfstate"

          echo "config_subpath=$CONFIG_SUBPATH" >> $GITHUB_OUTPUT
          echo "CONFIG_REGION=$CONFIG_REGION" >> $GITHUB_ENV
          echo "STATE_KEY=$STATE_KEY" >> $GITHUB_ENV
          echo "BUCKET_NAME=${{ inputs.bucket_name }}" >> $GITHUB_ENV
          echo "✅ Config: $CONFIG_SUBPATH"

      # =====================================================================
      # Auth & Backend
      # =====================================================================
      - name: Authenticate Azure
        if: inputs.cloud == 'azure'
        shell: bash
        run: |
          az login --service-principal \
            --username "$ARM_CLIENT_ID" \
            --password "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"
          az account set --subscription "$ARM_SUBSCRIPTION_ID"

      - name: Generate providers.tf
        shell: bash
        run: |
          # Use namespace from runner environment variable
          NAMESPACE="$STATE_NAMESPACE"
          if [ -z "$NAMESPACE" ]; then
            echo "❌ STATE_NAMESPACE is not set on the runner"
            exit 1
          fi

          # OCI Object Storage buckets are regional. We always take the bucket
          # region from the runner (STATE_REGION) to avoid coupling it to the
          # manifest folder name.
          if [ -z "${STATE_REGION:-}" ]; then
            echo "❌ STATE_REGION is required (OCI Object Storage bucket region)"
            exit 1
          fi
          BACKEND_REGION="$STATE_REGION"

          # Write backend.tf (Common)
          # We use OCI Object Storage for state regardless of the target cloud
          cat > ORCH/backend.tf << EOF
          terraform {
            backend "oci" {
              bucket    = "$BUCKET_NAME"
              key       = "$STATE_KEY"
              namespace = "$NAMESPACE"
              auth      = "InstancePrincipal"
              region    = "$BACKEND_REGION"
            }
          }
          EOF

          # Write providers.tf (Cloud specific)
          if [ "${{ inputs.cloud }}" = "oci" ]; then
            cat > ORCH/providers.tf << EOF
          provider "oci" {
            auth   = "InstancePrincipal"
            region = var.region
            ignore_defined_tags = ["Oracle-Tags.CreatedBy", "Oracle-Tags.CreatedOn"]
          }
          provider "oci" {
            auth   = "InstancePrincipal"
            alias  = "home"
            region = var.region
            ignore_defined_tags = ["Oracle-Tags.CreatedBy", "Oracle-Tags.CreatedOn"]
          }
          provider "oci" {
            auth   = "InstancePrincipal"
            alias  = "secondary_region"
            region = var.region
            ignore_defined_tags = ["Oracle-Tags.CreatedBy", "Oracle-Tags.CreatedOn"]
          }
          terraform {
            required_version = ">= 1.12.0"
            required_providers {
              oci = { source = "oracle/oci", configuration_aliases = [oci.home] }
            }
          }
          EOF
          else
            cat > ORCH/providers.tf << EOF
          provider "azurerm" { features {} }
          terraform {
            required_version = ">= 1.12.0"
            required_providers {
              azurerm = { source = "hashicorp/azurerm", version = "~> 3.0" }
            }
          }
          EOF
          fi

          terraform -chdir=ORCH fmt providers.tf
          echo "✅ Generated providers.tf"

      # =====================================================================
      # Terraform
      # =====================================================================
      - name: Terraform init
        shell: bash
        run: terraform -chdir=ORCH init

      - name: Terraform fmt
        id: format
        if: inputs.mode == 'pr'
        shell: bash
        run: terraform -chdir=ORCH fmt -check

      - name: Terraform validate
        id: validate
        if: inputs.mode == 'pr'
        shell: bash
        run: terraform -chdir=ORCH validate -no-color

      - name: Prepare variables
        id: vars
        shell: bash
        run: |
          CONFIG_DIR="${{ github.workspace }}/${{ steps.config.outputs.config_subpath }}"
          VAR_FILES=$(find "$CONFIG_DIR" -name '*.json' -printf '-var-file %p ')
          echo "var_files=$VAR_FILES" >> $GITHUB_OUTPUT

          EXTRA=""
          if [ "${{ inputs.cloud }}" = "oci" ]; then
            if [ -z "${CONFIG_REGION:-}" ]; then
              echo "❌ CONFIG_REGION missing (set inputs.region or runner REGION)"
              exit 1
            fi

            EXTRA="-var=region=$CONFIG_REGION -var=tenancy_ocid=dummy -var=user_ocid=dummy"
            EXTRA="$EXTRA -var=fingerprint=dummy -var=private_key_path=dummy -var=private_key_password=dummy"
          fi
          echo "extra=$EXTRA" >> $GITHUB_OUTPUT

      - name: Terraform plan
        id: plan
        shell: bash
        working-directory: ORCH
        run: |
          set -o pipefail
          terraform plan -detailed-exitcode -no-color \
            ${{ steps.vars.outputs.extra }} ${{ steps.vars.outputs.var_files }} \
            -out=tfplan.binary 2>&1 | tee plan.txt
          EXIT=${PIPESTATUS[0]}

          echo "plan_output<<EOF" >> $GITHUB_OUTPUT
          cat plan.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT" >> $GITHUB_OUTPUT

          # Exit codes: 0=no changes, 1=error, 2=changes detected
          # Only exit 1 is a real error
          if [ "$EXIT" -eq 1 ]; then
            exit 1
          fi
          # Exit 0 or 2 are both success (0=no changes, 2=changes to apply)
          exit 0

      - name: Terraform apply
        if: inputs.mode == 'apply'
        shell: bash
        run: |
          terraform -chdir=ORCH apply -auto-approve -no-color \
            ${{ steps.vars.outputs.extra }} ${{ steps.vars.outputs.var_files }}
          echo "✅ Apply completed"

      # =====================================================================
      # PR Comment
      # =====================================================================
      - name: Comment on PR
        if: inputs.mode == 'pr' && github.event.pull_request
        uses: actions/github-script@v8
        env:
          PLAN: ${{ steps.plan.outputs.plan_output }}
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### Terraform Plan

            **Format:** \`${{ steps.format.outcome }}\`
            **Validate:** \`${{ steps.validate.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`

            </details>

            *By @${{ github.actor }}*`
            });
