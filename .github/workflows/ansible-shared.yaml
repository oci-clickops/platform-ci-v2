name: Shared Ansible Workflow

on:
  workflow_call:
    inputs:
      mode:
        description: "check or execute"
        required: true
        type: string
      cloud:
        description: "oci or azure"
        required: true
        type: string
      operation_file:
        description: "Path to operation JSON file (auto-detected if not provided)"
        required: false
        type: string
      bucket_name:
        description: "Bucket name for state"
        required: true
        type: string
      runner_labels:
        description: "Runner labels as JSON array"
        required: false
        type: string
        default: '["self-hosted","oci"]'

jobs:
  ansible:
    name: "Ansible ${{ inputs.mode }}"
    runs-on: ${{ fromJSON(inputs.runner_labels) }}
    concurrency:
      group: ${{ inputs.cloud }}-ansible-${{ github.repository }}
      cancel-in-progress: false

    steps:
      # =====================================================================
      # Setup
      # =====================================================================
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup work directory
        shell: bash
        run: |
          WORK_TEMP="${{ runner.temp }}/ansible-work"
          mkdir -p "$WORK_TEMP"
          echo "WORK_TEMP=$WORK_TEMP" >> $GITHUB_ENV

      - name: Install Ansible
        shell: bash
        run: |
          python3.11 -m pip install --upgrade pip
          python3.11 -m pip install ansible==9.0.1
          ansible-galaxy collection install oracle.oci:5.5.0

      # =====================================================================
      # Detect operation file (if not provided)
      # =====================================================================
      - name: Detect operation file
        id: detect
        if: inputs.operation_file == ''
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > $WORK_TEMP/changed.txt
          elif [ "${{ github.event_name }}" = "push" ]; then
            git diff --name-only ${{ github.event.before }} ${{ github.event.after }} > $WORK_TEMP/changed.txt
          else
            find ${{ inputs.cloud }} -path '*/ansible/*.json' -type f > $WORK_TEMP/changed.txt
          fi

          OPERATION_FILE=$(grep '${{ inputs.cloud }}' $WORK_TEMP/changed.txt | grep 'ansible' | grep '.json' | head -1)

          if [ -z "$OPERATION_FILE" ]; then
            echo "❌ No Ansible operation files found"
            exit 1
          fi

          echo "operation_file=$OPERATION_FILE" >> $GITHUB_OUTPUT
          echo "✅ Found: $OPERATION_FILE"

      # =====================================================================
      # Discover operation
      # =====================================================================
      - name: Discover operation
        id: discover
        shell: bash
        run: |
          OPERATION_FILE="${{ inputs.operation_file || steps.detect.outputs.operation_file }}"
          FULL_PATH="${{ github.workspace }}/$OPERATION_FILE"

          # Extract operation_type from JSON
          OPERATION_TYPE=$(python3 -c "import json; print(json.load(open('$FULL_PATH'))['operation_type'])")

          # Extract config path (cloud/region)
          CONFIG_SUBPATH=$(echo "$OPERATION_FILE" | grep -oP '^[^/]+/[^/]+')
          REGION=$(echo "$CONFIG_SUBPATH" | cut -d'/' -f2)

          # Count targets
          TARGET_COUNT=$(python3 -c "
          import json
          m = json.load(open('$FULL_PATH'))
          t = m.get('targets', {})
          print(len(t.get('adb_resources', [])) + len(t.get('vm_resources', [])))
          ")

          echo "operation_type=$OPERATION_TYPE" >> $GITHUB_OUTPUT
          echo "config_subpath=$CONFIG_SUBPATH" >> $GITHUB_OUTPUT
          echo "target_count=$TARGET_COUNT" >> $GITHUB_OUTPUT
          echo "DETECTED_REGION=$REGION" >> $GITHUB_ENV
          echo "OPERATION_TYPE=$OPERATION_TYPE" >> $GITHUB_ENV
          echo "✅ $OPERATION_TYPE ($TARGET_COUNT targets)"

      # =====================================================================
      # Auth & Inventory
      # =====================================================================
      - name: Authenticate Azure
        if: inputs.cloud == 'azure'
        shell: bash
        run: |
          az login --service-principal \
            --username "$ARM_CLIENT_ID" \
            --password "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"
          az account set --subscription "$ARM_SUBSCRIPTION_ID"

      # STATE_NAMESPACE is provided by runner environment

      - name: Checkout platform-ci
        uses: actions/checkout@v6
        with:
          repository: oci-clickops/platform-ci-v2
          path: platform-ci

      - name: Generate inventory
        shell: bash
        run: |
          python3 platform-ci/scripts_python/ansible_inventory.py \
            "${{ inputs.cloud }}" \
            "${{ inputs.bucket_name }}" \
            "${{ steps.discover.outputs.config_subpath }}" \
            "${{ inputs.operation_file || steps.detect.outputs.operation_file }}"

      # =====================================================================
      # Execute Ansible
      # =====================================================================
      - name: Ansible check
        id: check
        if: inputs.mode == 'check'
        shell: bash
        working-directory: platform-ci/ansible
        run: |
          ansible-playbook \
            -i $WORK_TEMP/inventory.json \
            --check --diff \
            -e "@${{ github.workspace }}/${{ inputs.operation_file || steps.detect.outputs.operation_file }}" \
            playbooks/master.yml \
            --tags "$OPERATION_TYPE" \
            2>&1 | tee $WORK_TEMP/ansible.log || true

          echo "check_output<<EOF" >> $GITHUB_OUTPUT
          head -100 $WORK_TEMP/ansible.log >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Ansible execute
        id: execute
        if: inputs.mode == 'execute'
        shell: bash
        working-directory: platform-ci/ansible
        run: |
          ansible-playbook \
            -i $WORK_TEMP/inventory.json \
            -e "@${{ github.workspace }}/${{ inputs.operation_file || steps.detect.outputs.operation_file }}" \
            playbooks/master.yml \
            --tags "$OPERATION_TYPE" \
            2>&1 | tee $WORK_TEMP/ansible.log

          echo "✅ Execution completed"

      # =====================================================================
      # PR Comment
      # =====================================================================
      - name: Comment on PR
        if: inputs.mode == 'check' && github.event.pull_request
        uses: actions/github-script@v8
        env:
          OUTPUT: ${{ steps.check.outputs.check_output }}
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### Ansible Check

            **Operation:** \`${{ steps.discover.outputs.operation_type }}\`
            **Targets:** \`${{ steps.discover.outputs.target_count }}\`

            <details><summary>Show Output</summary>

            \`\`\`yaml
            ${process.env.OUTPUT}
            \`\`\`

            </details>

            *By @${{ github.actor }}*`
            });

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ansible-logs-${{ github.run_number }}
          path: ${{ env.WORK_TEMP }}/*.log
          if-no-files-found: ignore
