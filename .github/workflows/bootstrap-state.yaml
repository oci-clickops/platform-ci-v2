name: Bootstrap Terraform State (OCI)

on:
  workflow_dispatch:
    inputs:
      project:
        description: "Project/client identifier"
        required: true
        type: string
      provider:
        description: "GitOps stack that will consume this backend"
        required: true
        type: choice
        options: [azure, oci]
      region:
        description: "Primary region (fra, iad, etc.)"
        required: true
        type: string
      bucket_suffix:
        description: "Optional suffix to keep bucket names unique"
        required: false
        type: string
        default: ""

jobs:
  bootstrap:
    runs-on: self-hosted
    permissions:
      contents: write
    env:
      PROJECT_NAME: ${{ inputs.project }}
      TARGET_PROVIDER: ${{ inputs.provider }}
      TARGET_REGION: ${{ inputs.region }}
      BUCKET_SUFFIX: ${{ inputs.bucket_suffix }}
      OCI_REGION: ${{ secrets.OCI_REGION }}
      OCI_COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
      GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Guard – exit if secrets already exist
      run: |
        set -euo pipefail
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/secrets/TF_BUCKET")
        if [ "$STATUS" -eq 200 ]; then
          echo "TF_BUCKET secret already present. Bootstrap previously run – exiting."
          exit 0
        fi

    - name: Ensure OCI CLI is available
      run: |
        if ! command -v oci >/dev/null 2>&1; then
          pip install oci-cli
        fi

    - name: Create or reuse OCI bucket
      run: |
        set -euo pipefail
        source /opt/actions-runner/.github-runner-env
        BUCKET_NAME="tfstate-${PROJECT_NAME}${BUCKET_SUFFIX}"
        echo "Bucket: $BUCKET_NAME"
        if ! oci os bucket get --name "$BUCKET_NAME" --region "$OCI_REGION" --compartment-id "$OCI_COMPARTMENT_OCID" >/dev/null 2>&1; then
          oci os bucket create \
            --name "$BUCKET_NAME" \
            --compartment-id "$OCI_COMPARTMENT_OCID" \
            --region "$OCI_REGION" \
            --public-access-type NoPublicAccess
          echo "Bucket created."
        else
          echo "Bucket already exists, reusing."
        fi
        cat <<JSON > bootstrap_bucket.json
        {
          "bucket_name": "$BUCKET_NAME",
          "namespace": "$(oci os ns get --region "$OCI_REGION" --query data --raw-output)",
          "region": "$OCI_REGION",
          "key_prefix": "${PROJECT_NAME}/${TARGET_PROVIDER}/${TARGET_REGION}"
        }
JSON

    - name: Publish backend secrets
      run: |
        set -euo pipefail
        if ! command -v gh >/dev/null 2>&1; then
          sudo apt-get update && sudo apt-get install -y gh
        fi
        BUCKET=$(jq -r '.bucket_name' bootstrap_bucket.json)
        NAMESPACE=$(jq -r '.namespace' bootstrap_bucket.json)
        REGION=$(jq -r '.region' bootstrap_bucket.json)
        PREFIX=$(jq -r '.key_prefix' bootstrap_bucket.json)

        echo "$BUCKET"    | gh secret set TF_BUCKET --repo "$GITHUB_REPOSITORY"
        echo "$NAMESPACE" | gh secret set TF_NAMESPACE --repo "$GITHUB_REPOSITORY"
        echo "$PREFIX"    | gh secret set TF_KEY_PREFIX --repo "$GITHUB_REPOSITORY"
        echo "$REGION"    | gh secret set TF_STATE_REGION --repo "$GITHUB_REPOSITORY"
        echo "true"       | gh secret set TF_STATE_BOOTSTRAPPED --repo "$GITHUB_REPOSITORY"

    - name: Mark bootstrap completion
      run: |
        set -euo pipefail
        mkdir -p .bootstrap
        date -u +"%Y-%m-%dT%H:%M:%SZ" > .bootstrap/BOOTSTRAP_DONE
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add .bootstrap/BOOTSTRAP_DONE bootstrap_bucket.json
        git commit -m "Bootstrap OCI state for ${PROJECT_NAME}" || echo "Nothing to commit"
        git push || echo "Nothing to push"
