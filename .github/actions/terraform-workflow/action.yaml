name: "Terraform Workflow"
description: "Run Terraform: auth, config, plan"
inputs:
  cloud:
    description: "Cloud provider (oci or azure)"
    required: true
  mode:
    description: "Workflow mode (pr or apply)"
    required: true
  orchestrator-repo:
    description: "Terraform orchestrator repository"
    required: true
  bucket-name:
    description: "Bucket name for Terraform state"
    required: true
outputs:
  plan_output:
    description: "Plan output (sanitized)"
    value: ${{ steps.plan.outputs.plan_output }}
  plan_exit_code:
    description: "Plan exit code (0=no changes, 2=changes)"
    value: ${{ steps.plan.outputs.plan_exit_code }}
  format_outcome:
    description: "Format check result"
    value: ${{ steps.format.outcome }}
  validate_outcome:
    description: "Validate result"
    value: ${{ steps.validate.outcome }}
  config_subpath:
    description: "Config subdirectory path"
    value: ${{ steps.backend.outputs.config_subpath }}
runs:
  using: "composite"
  steps:
    # Setup work directory
    - name: Setup work directory
      shell: bash
      run: |
        # Create work temp directory
        WORK_TEMP="${{ runner.temp }}/terraform-work"
        mkdir -p "$WORK_TEMP"
        echo "WORK_TEMP=$WORK_TEMP" >> $GITHUB_ENV
        echo "Work directory: $WORK_TEMP"

    # Setup: Get code and tools
    - name: Checkout orchestrator repo
      uses: actions/checkout@v6
      with:
        repository: ${{ inputs.orchestrator-repo }}
        path: ORCH

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.12.1
        terraform_wrapper: true

    # Discover backend config
    - name: Find backend config
      id: backend
      shell: bash
      run: python3 "${{ github.action_path }}/../../../scripts_python/discover.py" terraform "${{ inputs.cloud }}" "${{ inputs.bucket-name }}"

    # Configure: Auth and backend
    - name: Authenticate to cloud
      shell: bash
      run: |
        if [ "${{ inputs.cloud }}" = "azure" ]; then
          az login --service-principal \
            --username "$ARM_CLIENT_ID" \
            --password "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"
          az account set --subscription "$ARM_SUBSCRIPTION_ID"
          echo "✅ Azure authentication complete"
        else
          echo "✅ OCI uses Instance Principal (automatic)"
        fi

    - name: Setup backend config
      shell: bash
      run: python3 "${{ github.action_path }}/../../../scripts_python/terraform_setup.py" "${{ inputs.cloud }}" "${{ github.workspace }}"

    # Terraform: Init and validate
    - name: Terraform init
      shell: bash
      working-directory: ${{ github.workspace }}/ORCH
      run: terraform init

    # PR only: check code formatting
    - name: Terraform format check
      id: format
      if: ${{ inputs.mode == 'pr' }}
      shell: bash
      working-directory: ${{ github.workspace }}/ORCH
      run: terraform fmt -check

    # PR only: validate configuration
    - name: Terraform validate
      id: validate
      if: ${{ inputs.mode == 'pr' }}
      shell: bash
      working-directory: ${{ github.workspace }}/ORCH
      run: terraform validate -no-color

    # Prepare Terraform variables
    - name: Prepare all variables
      id: vars
      shell: bash
      run: |
        # Step 1: Find all JSON config files
        CONFIG_DIR="${{ github.workspace }}/${{ steps.backend.outputs.config_subpath }}"
        find "$CONFIG_DIR" -name '*.json' > $WORK_TEMP/json_files.txt

        # Step 2: Build the var-file arguments
        VAR_FILES=""
        while read json_file; do
          VAR_FILES="$VAR_FILES -var-file $json_file"
        done < $WORK_TEMP/json_files.txt

        echo "var_files=$VAR_FILES" >> $GITHUB_OUTPUT
        echo "Found $(wc -l < $WORK_TEMP/json_files.txt) JSON config files"

        # Step 3: Build extra variables for OCI
        EXTRA_VARS=""
        if [ "${{ inputs.cloud }}" = "oci" ]; then
          EXTRA_VARS="-var=region=$DETECTED_REGION"
          EXTRA_VARS="$EXTRA_VARS -var=tenancy_ocid=dummy"
          EXTRA_VARS="$EXTRA_VARS -var=user_ocid=dummy"
          EXTRA_VARS="$EXTRA_VARS -var=fingerprint=dummy"
          EXTRA_VARS="$EXTRA_VARS -var=private_key_path=dummy"
          EXTRA_VARS="$EXTRA_VARS -var=private_key_password=dummy"
        fi

        echo "extra_vars=$EXTRA_VARS" >> $GITHUB_OUTPUT

    # Run plan
    - name: Terraform plan
      id: plan
      shell: bash
      working-directory: ${{ github.workspace }}/ORCH
      run: |
        # Step 1: Run terraform plan
        terraform plan -detailed-exitcode -no-color ${{ steps.vars.outputs.extra_vars }} ${{ steps.vars.outputs.var_files }} -out=tfplan.binary > plan_raw.txt 2>&1 || PLAN_EXIT=$?

        # Step 2: Save output for PR comment
        echo "plan_output<<EOF" >> $GITHUB_OUTPUT
        cat plan_raw.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "plan_exit_code=${PLAN_EXIT:-0}" >> $GITHUB_OUTPUT

        # Step 3: Show summary
        if [ "${PLAN_EXIT:-0}" -eq 0 ]; then
          echo "Plan completed: No changes needed"
        elif [ "${PLAN_EXIT:-0}" -eq 2 ]; then
          echo "Plan completed: Changes detected"
        fi

    # Save plan for later
    - name: Upload plan file
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.cloud }}-terraform-plan
        path: ${{ github.workspace }}/ORCH/tfplan.binary
        if-no-files-found: ignore

    # Apply: Run only when mode is apply
    - name: Terraform apply
      if: ${{ inputs.mode == 'apply' }}
      shell: bash
      working-directory: ${{ github.workspace }}/ORCH
      run: |
        # Apply the changes
        echo "Applying Terraform changes..."
        terraform apply -auto-approve -no-color ${{ steps.vars.outputs.extra_vars }} ${{ steps.vars.outputs.var_files }}

        echo "Apply completed successfully"
