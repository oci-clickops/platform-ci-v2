name: "Ansible Workflow"
description: "Execute Ansible operations with dynamic inventory and state tracking"
inputs:
  cloud:
    description: "Cloud provider (oci or azure)"
    required: true
  mode:
    description: "Workflow mode (check or execute)"
    required: true
  operation-file:
    description: "Path to operation JSON file"
    required: true
  bucket-name:
    description: "Bucket name for state files"
    required: true
outputs:
  check_output:
    description: "Check/dry-run output"
    value: ${{ steps.check.outputs.check_output }}
  operation_type:
    description: "Type of operation executed"
    value: ${{ steps.discover.outputs.operation_type }}
  target_count:
    description: "Number of targets"
    value: ${{ steps.discover.outputs.target_count }}
  precheck_outcome:
    description: "Pre-check validation result"
    value: ${{ steps.precheck.outcome }}
  execution_outcome:
    description: "Final execution result"
    value: ${{ steps.execute.outcome }}

runs:
  using: "composite"
  steps:
    # Setup work directory (should already be set by shared workflow, but ensure it exists)
    - name: Ensure work directory exists
      shell: bash
      run: |
        if [ -z "$WORK_TEMP" ]; then
          WORK_TEMP="${{ runner.temp }}/ansible-work"
          mkdir -p "$WORK_TEMP"
          echo "WORK_TEMP=$WORK_TEMP" >> $GITHUB_ENV
        fi
        echo "Work directory: $WORK_TEMP"

    # Setup Python
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"
        cache: "pip"

    # Setup: Install dependencies
    - name: Install Ansible and dependencies
      shell: bash
      run: |
        pip install ansible==9.0.1
        ansible-galaxy collection install oracle.oci:5.5.0
        echo "âœ… Ansible and OCI collection installed"

    # Discover: Parse operation manifest
    - name: Discover operation configuration
      id: discover
      shell: bash
      run: |
        python3 "${{ github.action_path }}/../../../scripts_python/discover.py" ansible \
          "${{ inputs.cloud }}" \
          "${{ github.workspace }}/${{ inputs.operation-file }}" \
          "${{ inputs.bucket-name }}"

    # Authenticate to cloud provider
    - name: Authenticate to cloud
      shell: bash
      run: |
        if [ "${{ inputs.cloud }}" = "azure" ]; then
          az login --service-principal \
            --username "$ARM_CLIENT_ID" \
            --password "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"
          az account set --subscription "$ARM_SUBSCRIPTION_ID"
          echo "âœ… Azure authentication complete"
        else
          echo "âœ… OCI uses Instance Principal (automatic)"
        fi

    # Get OCI namespace for Object Storage operations
    - name: Set OCI namespace
      if: ${{ inputs.cloud == 'oci' }}
      shell: bash
      run: |
        echo "ðŸ” Getting OCI Object Storage namespace..."
        NAMESPACE=$(oci os ns get --query data --raw-output)
        echo "STATE_NAMESPACE=$NAMESPACE" >> $GITHUB_ENV
        echo "âœ… OCI namespace set: $NAMESPACE"

    # Generate dynamic inventory from Terraform state
    - name: Generate dynamic inventory
      id: inventory
      shell: bash
      run: |
        python3 "${{ github.action_path }}/../../../scripts_python/ansible_generate_inventory.py" \
          "${{ inputs.cloud }}" \
          "${{ inputs.bucket-name }}" \
          "${{ steps.discover.outputs.config_subpath }}" \
          "${{ inputs.operation-file }}"

    # Check mode: Dry-run (like terraform plan)
    - name: Ansible check (dry-run)
      id: check
      if: ${{ inputs.mode == 'check' }}
      shell: bash
      working-directory: ${{ github.action_path }}/../../../ansible
      run: |
        # Run playbook in check mode
        OPERATION_TYPE="${{ steps.discover.outputs.operation_type }}"

        echo "ðŸ” Running Ansible in check mode (dry-run)..."

        ansible-playbook \
          -i $WORK_TEMP/inventory.json \
          --check \
          --diff \
          -e "@${{ github.workspace }}/${{ inputs.operation-file }}" \
          -e "ansible_state_file=$WORK_TEMP/ansible-state.json" \
          playbooks/master.yml \
          --tags "$OPERATION_TYPE" \
          > $WORK_TEMP/ansible-check.log 2>&1 || CHECK_EXIT=$?

        # Display output
        cat $WORK_TEMP/ansible-check.log

        # Save sanitized output for PR comment
        CHECK_OUTPUT=$(cat $WORK_TEMP/ansible-check.log | head -100)

        echo "check_output<<EOF" >> $GITHUB_OUTPUT
        echo "$CHECK_OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        exit ${CHECK_EXIT:-0}

    # Execute mode: Run the operation
    - name: Ansible execute
      id: execute
      if: ${{ inputs.mode == 'execute' }}
      shell: bash
      working-directory: ${{ github.action_path }}/../../../ansible
      run: |
        OPERATION_TYPE="${{ steps.discover.outputs.operation_type }}"

        echo "ðŸš€ Executing Ansible operation: $OPERATION_TYPE"

        ansible-playbook \
          -i $WORK_TEMP/inventory.json \
          -e "@${{ github.workspace }}/${{ inputs.operation-file }}" \
          -e "ansible_state_file=$WORK_TEMP/ansible-state.json" \
          playbooks/master.yml \
          --tags "$OPERATION_TYPE" \
          > $WORK_TEMP/ansible-execute.log 2>&1

        # Display output
        cat $WORK_TEMP/ansible-execute.log

        echo "âœ… Ansible execution completed"
